<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Negozio Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS -->
    <link rel="stylesheet" href="ecommerce.css">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container">
    <h1>Negozio Online</h1>

    <!-- Selezione marca -->
    <label for="marca-select">Seleziona Marca</label>
    <select id="marca-select">
        <option value="Marca1">Marca 1</option>
        <option value="Marca2">Marca 2</option>
    </select>

    <!-- Prodotti -->
    <h2>Prodotti</h2>
    <div id="product-list"></div>

    <!-- Carrello -->
    <h2>Carrello</h2>
    <div id="cart"></div>
    <h3 id="total">Totale: € 0.00</h3>

    <button id="generateReceipt">Stampa Scontrino</button>
</div>

<script>
let prodotti = [];
let carrello = [];

// Carica prodotti dal backend
function caricaProdotti(marca) {
    fetch('/api/prodotti/json')
        .then(res => res.json())
        .then(data => {
            prodotti = data.filter(p => p.marca === marca);
            mostraProdotti();
        });
}

document.getElementById('marca-select').addEventListener('change', e => {
    caricaProdotti(e.target.value);
});

// Mostra prodotti
function mostraProdotti() {
    const lista = document.getElementById('product-list');
    lista.innerHTML = '';

    prodotti.forEach(p => {
        const div = document.createElement('div');
        div.className = 'product-item';
        div.innerHTML = `
            <h3>${p.name}</h3>
            <p>${p.description}</p>
            <p><strong>€ ${p.price}</strong></p>
            <button onclick="aggiungiCarrello(${p.id})">
                Aggiungi
            </button>
        `;
        lista.appendChild(div);
    });
}

// Aggiungi al carrello
function aggiungiCarrello(id) {
    const prodotto = prodotti.find(p => p.id === id);
    const presente = carrello.find(p => p.id === id);

    if (presente) {
        presente.qta++;
    } else {
        carrello.push({ ...prodotto, qta: 1 });
    }

    aggiornaCarrello();
}

// Rimuovi prodotto
function rimuovi(id) {
    carrello = carrello.filter(p => p.id !== id);
    aggiornaCarrello();
}

// Aggiorna carrello
function aggiornaCarrello() {
    const cartDiv = document.getElementById('cart');
    cartDiv.innerHTML = '';
    let totale = 0;

    carrello.forEach(p => {
        totale += p.price * p.qta;

        cartDiv.innerHTML += `
            <div class="product-item">
                <h4>${p.name}</h4>
                <p>Prezzo: € ${p.price}</p>
                <p>Quantità: ${p.qta}</p>
                <button onclick="rimuovi(${p.id})">Rimuovi</button>
            </div>
        `;
    });

    document.getElementById('total').innerText =
        `Totale: € ${totale.toFixed(2)}`;
}

// Scontrino PDF
document.getElementById('generateReceipt').addEventListener('click', () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.text('SCONTRINO FISCALE', 10, 10);
    let y = 20;
    let totale = 0;

    carrello.forEach(p => {
        doc.text(
            `${p.name} x${p.qta} - € ${(p.price * p.qta).toFixed(2)}`,
            10, y
        );
        totale += p.price * p.qta;
        y += 10;
    });

    doc.text(`Totale: € ${totale.toFixed(2)}`, 10, y + 10);
    doc.save('scontrino.pdf');
});

// Avvio iniziale
caricaProdotti('Marca1');
</script>

</body>
</html>
